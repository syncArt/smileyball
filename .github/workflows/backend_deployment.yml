name: Deploy Smileyball Backend

on:
  workflow_dispatch:

jobs:
  deploy-smileyball-backend:
    runs-on: ubuntu-latest
    environment: production
    env:
      SMILEYBALL_BACKEND_CANISTER_ID: ${{ secrets.SMILEYBALL_BACKEND_CANISTER_ID }}
      WALLET_CANISTER_ID: ${{ secrets.WALLET_CANISTER_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dfx
        uses: dfinity/setup-dfx@main

      - name: Confirm successful installation
        run: dfx --version

      - name: Check Rust and Cargo versions
        run: |
          rustc --version
          cargo --version

      - name: Install Candid Extractor
        run: cargo install candid-extractor

      - name: Install wasm32-unknown-unknown target for Rust
        run: rustup target add wasm32-unknown-unknown

      - name: Install Smileyball Identity
        env:
          DFX_DEPLOY_KEY: ${{ secrets.DFX_DEPLOY_KEY }}
        run: |
          key_pem=$(mktemp)
          printenv "DFX_DEPLOY_KEY" > "$key_pem"
          dfx identity import --disable-encryption --force smileyball "$key_pem"
          rm "$key_pem"
          dfx identity use smileyball

      - name: Check If have permissions
        run: dfx canister --network ic status ${{ env.SMILEYBALL_BACKEND_CANISTER_ID }}

      - name: Start DFX server in the background
        run: |
          nohup dfx start --background --clean &
          # Wait until DFX is ready
          until dfx ping; do sleep 1; done

      - name: Create Backend Canister
        run: dfx canister create smileyball_backend

      - name: Build all backend canisters
        run: dfx build smileyball_backend --ic

      - name: Generate Candid Types
        run: candid-extractor target/wasm32-unknown-unknown/release/smileyball_backend.wasm > src/smileyball_backend/smileyball_backend.did

      - name: Verify Current Directory
        run: |
          echo "Current working directory:"
          pwd
          echo "Listing all files and directories in the current location:"
          ls -la

      - name: Check for .dfx Folder
        run: |
          if [ -d ".dfx" ]; then
            echo ".dfx folder exists."
            ls -la .dfx  # List contents of .dfx to verify structure
          else
            echo ".dfx folder does not exist."
            exit 1  # Fail the workflow if .dfx does not exist
          fi

      - name: Verify Backend Wasm File Exists
        run: |
          if [ -f ".dfx/ic/canisters/smileyball_backend/smileyball_backend.wasm" ]; then
            echo "Backend Wasm file exists:"
            ls -la .dfx/ic/canisters/smileyball_backend/
          else
            echo "Backend Wasm file does not exist in .dfx/ic/canisters/smileyball_backend/"
            exit 1  # Fail the workflow if the Wasm file does not exist
          fi

      - name: Deploy Smileyball Backend on ICP
        run: |
          dfx canister install smileyball_backend --network ic --mode upgrade --yes

      - name: Stop DFX server and clean up processes
        run: |
          dfx stop || true 
          pkill -f 'dfx start' || true 
          pkill -f 'dfx replica' || true
      - name: Clean up .dfx folder
        run: |
          rm -rf .dfx
